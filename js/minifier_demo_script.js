// updated 31/8/24 compressed version of demo page script for faster loading 
var cy,initialElements=[],startNodeSelected=!1,mobileDisplay=window.innerWidth<=500,slider=document.getElementById("speed-input"),output=document.getElementById("speed-label"),mobileSlider=document.getElementById("mobile-speed-input"),mobileSliderOutput=document.getElementById("mobile-speed-label"),pValueModal=document.getElementById("p-value-modal"),pValueBtn=document.getElementById("change-p-btn"),pValueForm=document.getElementById("change-p-value"),closeModal=document.getElementById("p-value-close"),closeDemoModal=document.getElementById("demo-end-close"),closeStatsModal=document.getElementById("stats-end-close"),hiddenMenu=document.getElementById("hamburger-menu"),menuIcon=document.getElementById("hamburger-icon"),nodeTransitionDuration=!0===mobileDisplay?750/mobileSlider.value:750/slider.value,nodeTransitionCount=0,isPaused=!1,numIterations=0,pausedNumIterations=-1,graphDict={};const nodePositionUrl="data/node_position.txt",nodeEdgesUrl="data/Vertices.txt",fetchAndParse=e=>fetch(e).then(t=>{if(!t.ok)throw Error(`Failed to fetch ${e}: ${t.statusText}`);return t.text()}).then(e=>JSON.parse(e));function addSelfLoops(e){for(let t=0;t<100;t++)cy.add({group:"edges",data:{id:`${t}-${t}`,source:t,target:t,weight:e}})}function normalizeWeights(){var e=!1,t=0;1===arguments.length&&(e=!0,t=arguments[0]),cy.nodes().forEach(function(e){var n=e.outgoers("edge");0!=n.length&&n.forEach(function(e){e.source().id()!=e.target().id()&&e.data("weight",String((1-t)/n.length))})})}function iterate(){numIterations++,cy.nodes().forEach(function(e){var t=e.outgoers("node"),n=e.outgoers("edge").map(function(e){return e.data("weight")});let o=0;if(t){let a=Math.random();for(let l=0;l<n.length;l++)if(a<(o+=Number(n[l]))){let i=t[l];"#808080"!=i.data("color")&&e.data("new-color",i.data("color"));break}}}),changeNodeColors(),document.getElementById("dynamic-iterations-label").innerHTML="Number of Iterations:"+numIterations}function countNodesWithColor(e){return cy.nodes().filter(function(t){return t.data("color")===e}).size()}function changeNodeColors(){cy.nodes().forEach(function(e){e.data("color")!=e.data("new-color")&&void 0!==e.data("new-color")&&(e.animate({style:{"background-color":e.data("new-color")}},{duration:nodeTransitionDuration}),e.data("colorHistory")[numIterations-1]=e.data("color"),e.data("colorHistory")[numIterations]=e.data("new-color"),e.data("color",e.data("new-color")))})}function checkConsensus(e){var t=cy.nodes()[0].data("color");for(let n=0;n<cy.nodes().length;n++)if(t!=cy.nodes()[n].data("color"))return!1;if(!startNodeSelected)return!1;index=Array.from({length:e},(e,t)=>t+1);let o=["Index",...Object.keys(graphDict)],a=[],l=Object.values(graphDict)[0].length;for(let i=0;i<l;i++){let d=[i];for(let r of Object.keys(graphDict))d.push(graphDict[r][i]);a.push(d)}let s=[o,...a].map(e=>e.join(",")).join("\n"),c=new Blob([s],{type:"text/csv"}),u=document.getElementById("csvLink");return u.href=URL.createObjectURL(c),u.download="dictionary.csv",updateEndGameModal(e,t),document.getElementById("demo-end").style.display="block",document.getElementById("simulate-btn").disabled=!1,!0}function simulate(e){if(e){let t=new Set;cy.nodes().forEach(e=>{let n=e.data("color");t.add(n)}),t.delete("#808080");let n=Array.from(t);for(let o=0;o<n.length;o++)graphDict[n[o]]=[]}simulationTimeout=setTimeout(function(){for(let[e,t]of Object.entries(graphDict))graphDict[e].push(countNodesWithColor(e));if(checkConsensus(numIterations)||isPaused){pausedNumIterations=numIterations;return}iterate(),simulate(!1)},1500/(speedSlider=!0===mobileDisplay?mobileSlider:slider).value)}function updateEndGameModal(e,t){document.getElementById("iterations-label").innerHTML=e,document.getElementById("winning-player").style.color=t}function updateLineGraph(){let e=Object.entries(graphDict).map(([e,t],n)=>({label:e,data:t,borderColor:e,fill:!1})),t=document.getElementById("line-graph").getContext("2d");Chart.defaults.font.size=14,new Chart(t,{type:"line",data:{labels:Array.from({length:Object.values(graphDict)[0].length},(e,t)=>t),datasets:e},options:{responsive:!0,maintainAspectRatio:!1,devicePixelRatio:4,animation:!1,plugins:{title:{display:!0,text:"Number of Nodes belonging to a Colour in every Iteration",color:"#fffffe"}},layout:{padding:{left:20,top:20,right:40,bottom:20}},scales:{x:{title:{display:!0,text:"Number of Iterations",color:"#fffffe"},ticks:{color:"#808080"},grid:{color:"#808080"},beginAtZero:!0},y:{title:{display:!0,text:"Number of Nodes",color:"#fffffe"},ticks:{color:"#808080"},grid:{color:"#808080"}}}}}),t.canvas.style.backgroundColor="#242629"}function undoIterate(){numIterations-1>=0&&(numIterations-=1,cy.nodes().forEach(function(e){e.data("colorHistory").hasOwnProperty(numIterations)&&(e.animate({style:{"background-color":e.data("colorHistory")[numIterations]}},{duration:0}),e.data("new-color",e.data("color")),e.data("color",e.data("colorHistory")[numIterations]))}),document.getElementById("dynamic-iterations-label").innerHTML="Number of Iterations:"+numIterations)}function redoIterate(){numIterations+1<=pausedNumIterations&&(numIterations++,cy.nodes().forEach(function(e){e.data("colorHistory").hasOwnProperty(numIterations)&&(e.animate({style:{"background-color":e.data("colorHistory")[numIterations]}},{duration:0}),e.data("new-color",void 0),e.data("color",e.data("colorHistory")[numIterations]),console.log(e.data()))}),document.getElementById("dynamic-iterations-label").innerHTML="Number of Iterations:"+numIterations)}function toggleSimulationBtns(){startNodeSelected?(document.getElementById("simulate-btn").disabled=!1,document.getElementById("animate-btn").disabled=!1):(document.getElementById("simulate-btn").disabled=!0,document.getElementById("animate-btn").disabled=!0)}function togglePlaybackBtns(e){e?(document.getElementById("sim-back-btn").disabled=!1,document.getElementById("sim-forward-btn").disabled=!1):e||(document.getElementById("sim-back-btn").disabled=!0,document.getElementById("sim-forward-btn").disabled=!0)}function reloadGraph(){startNodeSelected=!1,toggleSimulationBtns(),location.reload()}function resetPlayPauseBtn(){isPaused&&(isPaused=!1,document.getElementById("sim-pause-play-btn").style.backgroundColor="#7f5af0")}function changePValue(e){e&&(cy.edges().forEach(function(t){t.source().id()===t.target().id()&&t.data("weight",String(e))}),addSelfLoops(e),normalizeWeights(e))}pValueBtn.onclick=function(){"Not valid. Please enter a value between 0-1:"==document.getElementById("p-value-label").textContent&&(document.getElementById("p-value-label").textContent="Please enter a value between 0-1:"),pValueModal.style.display="block"},closeModal.onclick=function(){pValueModal.style.display="none"},closeDemoModal.onclick=function(){document.getElementById("demo-end").style.display="none"},closeStatsModal.onclick=function(){document.getElementById("statistic-modal").style.display="none",Chart.getChart("line-graph")&&Chart.getChart("line-graph")?.destroy()},window.addEventListener("resize",function(e){cy.resize(),cy.fit(),mobileDisplay=window.innerWidth<=500}),window.onclick=function(e){e.target==pValueModal?pValueModal.style.display="none":e.target==document.getElementById("demo-end")&&(document.getElementById("demo-end").style.display="none")},pValueForm.addEventListener("submit",function(e){e.preventDefault();let t=pValueForm.elements.pValue.value;isNaN(t)||t<0||t>1?(document.getElementById("p-value-label").textContent="Not valid. Please enter a value between 0-1:",pValueForm.reset()):(document.getElementById("p-value-label").textContent="Please enter a value between 0-1:",changePValue(parseFloat(t)),pValueModal.style.display="none")}),document.getElementById("hamburger-menu-icon").addEventListener("click",function(){"block"===hiddenMenu.style.display?(hiddenMenu.style.display="none",menuIcon.style.color="#fffffe"):(hiddenMenu.style.display="block",menuIcon.style.color="#2cb67d")}),document.getElementById("reset-btn").addEventListener("click",function(){reloadGraph()}),document.getElementById("mobile-reset-btn").addEventListener("click",function(){reloadGraph()}),document.getElementById("animate-btn").addEventListener("click",function(){iterate(),togglePlaybackBtns(!1),resetPlayPauseBtn()}),document.getElementById("simulate-btn").addEventListener("click",function(){simulate(!0),togglePlaybackBtns(!1),resetPlayPauseBtn(),document.getElementById("simulate-btn").disabled=!0}),document.getElementById("color-picker").addEventListener("input",function(e){let t=e.target.value;cy.on("tap","node",function(e){var n=e.target;n.data("color",t),n.style("background-color",t),n.data("colorHistory")[0]=t,cy.off("tap","node"),startNodeSelected=!0,toggleSimulationBtns()})}),document.getElementById("select-purple-btn").addEventListener("click",function(){cy.on("tap","node",function(e){var t=e.target;t.data("color","#7f5af0"),t.data("colorHistory")[0]="#7f5af0",console.log(t.data()),cy.off("tap","node"),startNodeSelected=!0,toggleSimulationBtns()})}),document.getElementById("select-green-btn").addEventListener("click",function(){cy.on("tap","node",function(e){var t=e.target;t.data("color","#2cb67d"),t.data("colorHistory")[0]="#2cb67d",cy.off("tap","node"),startNodeSelected=!0,toggleSimulationBtns()})}),document.getElementById("node-effect-btn").addEventListener("click",function(e){document.getElementById("node-effect-btn").style.backgroundColor=1===nodeTransitionCount?"#7f5af0":"#553ba3",nodeTransitionDuration=1===nodeTransitionCount?1e3/slider.value:0,nodeTransitionCount=1===nodeTransitionCount?0:1}),document.getElementById("mobile-node-effect-btn").addEventListener("click",function(e){document.getElementById("mobile-node-effect-btn").style.backgroundColor=1===nodeTransitionCount?"#7f5af0":"#553ba3",nodeTransitionDuration=1===nodeTransitionCount?1e3/mobileSlider.value:0,nodeTransitionCount=1===nodeTransitionCount?0:1}),document.getElementById("sim-pause-play-btn").addEventListener("click",function(e){var t=document.getElementById("sim-pause-play-btn");pausedNumIterations=!0==(isPaused=!0!==isPaused)?numIterations:-1,t.style.backgroundColor=!0===isPaused?"#553ba3":"#7f5af0",isPaused?isPaused&&numIterations==pausedNumIterations&&(document.getElementById("simulate-btn").disabled=!1):(document.getElementById("simulate-btn").disabled=!1,togglePlaybackBtns(!1),simulate(!1)),isPaused&&togglePlaybackBtns(!0)}),document.getElementById("sim-back-btn").addEventListener("click",function(e){undoIterate(),numIterations<pausedNumIterations&&(document.getElementById("simulate-btn").disabled=!0,document.getElementById("sim-pause-play-btn").disabled=!0,document.getElementById("animate-btn").disabled=!0)}),document.getElementById("sim-forward-btn").addEventListener("click",function(e){redoIterate(),numIterations<pausedNumIterations?(document.getElementById("simulate-btn").disabled=!0,document.getElementById("sim-pause-play-btn").disabled=!0,document.getElementById("animate-btn").disabled=!0):numIterations==pausedNumIterations&&(document.getElementById("simulate-btn").disabled=!1,document.getElementById("sim-pause-play-btn").disabled=!1,document.getElementById("animate-btn").disabled=!1)}),document.getElementById("graph-btn").addEventListener("click",function(e){updateLineGraph(),document.getElementById("statistic-modal").style.display="block"}),slider.oninput=function(){output.innerHTML="Speed Multiplier :x"+parseFloat(this.value).toFixed(1)},mobileSlider.oninput=function(){mobileSliderOutput.innerHTML="Speed Multiplier :x"+parseFloat(this.value).toFixed(1)},Promise.all([fetchAndParse("data/node_position.txt"),fetchAndParse("data/Vertices.txt")]).then(e=>{let[t,n]=e,o=t,a=n;console.log("Parsed JSON from file nodePositions:",t),console.log("Parsed JSON from file nodeEdges:",n);for(let l=0;l<o.length;l++)initialElements.push({group:"nodes",data:{id:`${l}`,color:"#808080",colorHistory:{0:"#808080"}},position:{x:Math.round(o[l][0]*window.innerWidth*2),y:Math.round(o[l][1]*window.innerHeight*1.6)}});for(let i=0;i<100;i++)for(let d=0;d<a[i].length;d++)initialElements.push({group:"edges",data:{id:`${i}-${a[i][d]}`,source:i,target:a[i][d],weight:1}});toggleSimulationBtns(),togglePlaybackBtns(!1),cy=window.cy=cytoscape({container:document.getElementById("cy"),boxSelectionEnabled:!1,autounselectify:!0,userZoomingEnabled:!0,zoom:2,pan:{x:0,y:0},layout:{name:"preset"},style:[{selector:"node",style:{height:40,width:40,label:"data(id)","text-valign":"center","background-color":"data(color)",color:"#16161a","z-index":10}},{selector:"edge",style:{"curve-style":"haystack","haystack-radius":0,width:5,opacity:.5,"line-color":"#72757e","z-index":2}}],elements:initialElements}),normalizeWeights()}).catch(e=>{console.error("Error fetching or parsing files:",e)});